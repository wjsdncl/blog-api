generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
  schemas  = ["public", "auth"]
}

// ============================================
// 사용자 & 인증
// ============================================

/// 인증 정보 (OAuth 전용)
model Auth {
  id          String   @id @default(uuid()) // 인증 정보 ID
  user_id     String   @unique // 사용자 ID (1:1)
  provider    String // OAuth 제공자 (GITHUB, GOOGLE)
  provider_id String // OAuth 제공자 사용자 ID
  created_at  DateTime @default(now()) // 생성일
  updated_at  DateTime @updatedAt // 수정일

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([provider, provider_id])
  @@index([user_id])
  @@map("auth")
  @@schema("auth")
}

/// 사용자 기본 정보
model User {
  id         String   @id @default(uuid()) // 사용자 고유 ID
  username   String   @unique // 사용자명
  email      String   @unique // 이메일
  role       role     @default(USER) // 사용자 권한
  is_active  Boolean  @default(true) // 계정 활성화 상태
  created_at DateTime @default(now()) // 생성일
  updated_at DateTime @updatedAt // 수정일

  auth         Auth?
  comments     Comment[]
  postLikes    PostLike[]
  commentLikes CommentLike[]

  @@index([email])
  @@index([username])
  @@index([is_active])
  @@map("users")
  @@schema("public")
}

// ============================================
// 블로그 콘텐츠
// ============================================

/// 블로그 게시글
model Post {
  id            String         @id @default(uuid()) // 게시글 ID
  title         String // 제목
  slug          String         @unique // URL 경로
  content       String         @db.Text // 본문 (Markdown/HTML)
  excerpt       String?        @db.Text // 요약
  cover_image   String? // 커버 이미지 URL
  status        publish_status @default(DRAFT) // 게시글 상태
  view_count    Int            @default(0) // 조회수
  like_count    Int            @default(0) // 좋아요 수 (비정규화)
  comment_count Int            @default(0) // 댓글 수 (비정규화)
  category_id   String? // 카테고리 ID
  published_at  DateTime? // 최초 공개일 (예약 발행 시간)
  created_at    DateTime       @default(now()) // 생성일
  updated_at    DateTime       @updatedAt // 수정일

  category  Category?  @relation(fields: [category_id], references: [id], onDelete: SetNull)
  tags      Tag[]
  comments  Comment[]
  postLikes PostLike[]

  @@index([category_id])
  @@index([slug])
  @@index([status, created_at])
  @@index([category_id, status])
  @@index([like_count])
  @@index([comment_count])
  @@map("posts")
  @@schema("public")
}

/// 게시글 카테고리
model Category {
  id         String   @id @default(uuid()) // 카테고리 ID
  name       String   @unique // 카테고리명
  slug       String   @unique // URL 경로
  order      Int      @default(0) // 정렬 순서
  post_count Int      @default(0) // 게시글 수 (비정규화)
  created_at DateTime @default(now()) // 생성일
  updated_at DateTime @updatedAt // 수정일

  posts      Post[]
  portfolios Portfolio[]

  @@index([slug])
  @@index([order])
  @@index([post_count])
  @@map("categories")
  @@schema("public")
}

/// 태그
model Tag {
  id         String   @id @default(uuid()) // 태그 ID
  name       String   @unique // 태그명
  slug       String   @unique // URL 경로
  created_at DateTime @default(now()) // 생성일
  updated_at DateTime @updatedAt // 수정일

  posts      Post[]
  portfolios Portfolio[]

  @@index([slug])
  @@index([name])
  @@map("tags")
  @@schema("public")
}

// ============================================
// 댓글 & 좋아요
// ============================================

/// 댓글 (Self-Referencing 답글 구조)
model Comment {
  id         String    @id @default(uuid()) // 댓글 ID
  content    String    @db.Text // 댓글 내용
  post_id    String // 게시글 ID
  author_id  String // 작성자 ID
  parent_id  String? // 부모 댓글 ID (NULL=댓글, 값=답글)
  deleted_at DateTime? // 삭제 시각 (NULL=활성, 값=soft delete)
  created_at DateTime  @default(now()) // 생성일
  updated_at DateTime  @updatedAt // 수정일

  post         Post          @relation(fields: [post_id], references: [id], onDelete: Cascade)
  author       User          @relation(fields: [author_id], references: [id], onDelete: Cascade)
  parent       Comment?      @relation("CommentReplies", fields: [parent_id], references: [id], onDelete: Cascade)
  replies      Comment[]     @relation("CommentReplies")
  commentLikes CommentLike[]

  @@index([post_id])
  @@index([author_id])
  @@index([parent_id])
  @@index([post_id, deleted_at, created_at])
  @@index([author_id, created_at])
  @@map("comments")
  @@schema("public")
}

/// 게시글 좋아요
model PostLike {
  id         String   @id @default(uuid()) // 좋아요 ID
  user_id    String // 사용자 ID
  post_id    String // 게시글 ID
  created_at DateTime @default(now()) // 생성일

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)
  post Post @relation(fields: [post_id], references: [id], onDelete: Cascade)

  @@unique([user_id, post_id])
  @@index([post_id, created_at])
  @@index([user_id, created_at])
  @@map("post_likes")
  @@schema("public")
}

/// 댓글 좋아요
model CommentLike {
  id         String   @id @default(uuid()) // 좋아요 ID
  user_id    String // 사용자 ID
  comment_id String // 댓글 ID
  created_at DateTime @default(now()) // 생성일

  user    User    @relation(fields: [user_id], references: [id], onDelete: Cascade)
  comment Comment @relation(fields: [comment_id], references: [id], onDelete: Cascade)

  @@unique([user_id, comment_id])
  @@index([comment_id, created_at])
  @@index([user_id, created_at])
  @@map("comment_likes")
  @@schema("public")
}

// ============================================
// 포트폴리오
// ============================================

/// 포트폴리오 (프로젝트)
model Portfolio {
  id           String        @id @default(uuid()) // 포트폴리오 ID
  title        String // 프로젝트 제목
  slug         String        @unique // URL 경로
  content      String        @db.Text // 프로젝트 상세 설명
  excerpt      String?       @db.Text // 짧은 요약
  cover_image  String? // 커버 이미지 URL
  start_date   DateTime? // 시작일
  end_date     DateTime? // 종료일 (NULL=진행중)
  status       publish_status @default(DRAFT) // 포트폴리오 상태
  view_count   Int           @default(0) // 조회수
  order        Int           @default(0) // 정렬 순서
  category_id  String? // 카테고리 ID
  published_at DateTime? // 최초 공개일 (예약 발행 시간)
  created_at   DateTime      @default(now()) // 생성일
  updated_at   DateTime      @updatedAt // 수정일

  category   Category?       @relation(fields: [category_id], references: [id], onDelete: SetNull)
  tags       Tag[]
  links      PortfolioLink[]
  techStacks TechStack[]

  @@index([category_id])
  @@index([slug])
  @@index([status, order])
  @@map("portfolios")
  @@schema("public")
}

/// 포트폴리오 링크 (프로젝트 관련 URL)
model PortfolioLink {
  id           String   @id @default(uuid()) // 링크 ID
  portfolio_id String // 포트폴리오 ID
  type         String // 링크 타입 (live, github, demo, figma 등)
  url          String // 링크 URL
  label        String? // 링크 레이블
  order        Int      @default(0) // 정렬 순서
  created_at   DateTime @default(now()) // 생성일
  updated_at   DateTime @updatedAt // 수정일

  portfolio Portfolio @relation(fields: [portfolio_id], references: [id], onDelete: Cascade)

  @@index([portfolio_id, order])
  @@index([type])
  @@map("portfolio_links")
  @@schema("public")
}

/// 기술 스택 (재사용 가능한 기술 정보)
model TechStack {
  id         String   @id @default(uuid()) // 기술 스택 ID
  name       String   @unique // 기술명 (React, TypeScript 등)
  category   String? // 카테고리 (Frontend, Backend 등)
  created_at DateTime @default(now()) // 생성일
  updated_at DateTime @updatedAt // 수정일

  portfolios Portfolio[]

  @@index([name])
  @@index([category])
  @@map("tech_stacks")
  @@schema("public")
}

// ============================================
// Enum
// ============================================
/// 게시글/포트폴리오 발행 상태
enum publish_status {
  DRAFT // 임시저장
  PUBLISHED // 공개
  SCHEDULED // 예약 발행

  @@schema("public")
}

/// 사용자 권한
enum role {
  USER // 일반 사용자
  OWNER // 블로그 소유자 (관리자)

  @@schema("public")
}
